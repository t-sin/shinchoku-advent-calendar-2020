# ゲームボーイ関連開発

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の20日目の記事です。

## 概要

ゲームボーイのソフトウェアやエミュレータをつくりたいなあという話です。

## 動機

初めて触れたゲーム機が初代ゲームボーイでした。ピコピコとした音やあの緑がかった液晶の色合いが (見にくかったし眼鏡になった原因これっぽいけど) 小さいころの原風景として記憶に残っています。ソフトでいうと『スーパーマリオランド2』や『ゼルダの伝説 夢を見る島』、あと『星のカービィ2』あたりがとても記憶に残っています。カービィ2の特に音づかいは自作のチップチューン曲 ([これ](https://soundcloud.com/sin_clav/roadside-trees?in=sin_clav/sets/my-game-music-like-songs)とか[これ](https://soundcloud.com/sin_clav/lemon-leaves?in=sin_clav/sets/my-game-music-like-songs)) にも如実に影響が現われているくらいです。

そんなふうな人間なのでゲーム開発には昔からとても興味がありました。エミュレータの存在を知ると同時に家庭のパソコンでもゲームボーイ等のソフトウェアを開発できる方法があると知って、当時はプログラミングまったく知りませんでしたがちょっとアツい気持ちになったりしていました。

一方で、「ゲームボーイのソフトウェア開発にはアセンブラが必須らしい」「パソコンじゃないからよくわからない」「描画はドット単位じゃないらしいぞなにそれ」「ハードウェアこわい」などのイメージがありこわくて手を出せていませんでした。

しかし近年低レイヤー的な部分 (仮想機械とか計算機アーキテクチャとかアセンブリ言語とか) に興味を持ち、これまで進捗アドベントカレンダー記事として書いたようなことを失敗しながらもやってきた結果、そろそろやってみていいのでは、という気持ちになれました。あとこちらの[ゲームボーイのエミュレータを自作した話 · Keichi Takahashi](https://keichi.net/post/write-yourself-a-game-boy-emulator/)と[ゲームボーイのエミュレータをGoで作った話 - Qiita](https://qiita.com/Akatsuki_py/items/3a8ddef98343e805b8c1)に勇気をもらったというのもあります。

そこで、ぼくが挑戦して (そして現在止まっている) ゲームボーイ関連の開発のことを書きます。

## ゲームボーイエミュレータ

CPUの動作原理も勉強もいっしょにしたいと思ったので、まずゲームボーイのエミュレータをつくろうと考えます。ちょこっと調べるとゲームボーイのCPUはZilogのZ80という組み込み向けCPUの亜種のようです。そこで「Z80エミュつくってゲームボーイ用に改変していけばよいのだな！」と思ってつくりはじめます。あ、リポジトリはこちらです。

https://github.com/t-sin/lambdaboy

ご覧のとおりエタりかけています。調査が粗い状態ではじめてしまうのをなんとかせねばなんですが、ゲームボーイのCPUは実際にはZ80とIntelの8080の合いの子のような感じで8080色が強いらしく、Z80だと思ってつくると痛い目を見れそうです。そしてエミュレータ自作自体が初めてなのにあまり既存コード読み等の調査をしておらず、頓挫までの道がわりと容易に想像がつきます。正しく調査をすると、ゲームボーイはCPUのほかにAPUという音を計算する専用プロセッサが載っていてメモリにマップされたレジスタ越しに音の生成を操作するしくみになっているなどの事実がわかります。このあたりを怠りがちなのはなんとかしたほうがいいですね。

---

(ところで今なんだかおもしろそうなページを見つけてしまいました: [はじめに | シェルスクリプトで ゲームボーイプログラミング 入門](http://yuma.ohgami.jp/GB-Programming-with-Shell-Script/intro.html)。気になる…。)

---

ちょっと面白かったのは、lambdaboyをつくっていたら[Clojureでゲームボーイエミュレータ](https://github.com/Tko1/Lispboy)を作っている人からメールがきてちょっと仲良くなったりした点です。そして英語力のなさを超絶痛感するという。

---

話を戻します。動機にも挙げた記事にじつは記述もありしっかりとリンクも張られていることなのですが、まずテストROMを通すような動きにしたほうがよかったなというのが反省点です。実行イメージが得られないままに開発をするとモチベーションが確実に潰えますし、なによりも実装の方針が立たないです。実装方針という意味ではエミュレータに載せる機能を決めることとか、既存実装の調査とか、そういうところを蔑ろにしたなというのも反省点です。

ちなみにいつか完成させたいのでエタっていません。いまは「ROM吸い出し機必要だな」という気持ちが強いです。

## ゲームボーイソフトウェア開発

そしてもうひとつやりたいことがあります。ゲームボーイのソフトウェア開発です。自分の書いたソフトウェアがあの、あのゲームボーイで動くなんて試してみたいですよね？ そうするときっと胸がアツい気持ちになれるはずです。

そんなわけでGNU/Linuxでの開発環境を探します。この時期、[6日目記事](articles/2020-12-06.md)にあるようにアセンブリ言語の勉強を終えた直後だったため「アセンブラいける！！」という気持ちがしたのでGB用アセンブラを探します。[RGBDS](https://github.com/gbdev/rgbds)がよいようでした。エミュレータは[こちらのページ](http://mydocuments.g2.xrea.com/html/gb/gb.html)に記載のある[bgb (デバッガが優秀)](http://bgb.bircd.org)と[gambatte (実機再現度が高い)](https://github.com/sinamas/gambatte)の複数を用意しておいて、原因の切り分けに用います。

ちなみにRGBDS、アセンブラだけでなくGB用のリンカもついていてオブジェクトファイルフォーマットもmanに記載されており、ソースコードもC言語でそんなに大きくない量なので、ツールチェインの勉強をするのにもすごくよさそうだなあと感じました。

進捗としては停止しているのですが、ゲームボーイのプログラミングはソフトウェア的な部分だけでなくハードウェア的な規約 (画面に書き込みをするときは画面をシャットダウンしてからやらないと実機壊れる、など) がたくさんあり、また今回の方法だと生で機械語を叩くため理解しにくく、その上アセンブリ言語まだよくわかってなかったため頓挫してしまいました。[6日目記事](articles/2020-12-06.md)にも書いたオートマトン的な方法を習得して、またドキュメント類を読み込んだ上でチュートリアルにチャレンジするといいかもしれないなと思った次第です。

最後に、実際に書いていたゲームボーイのソフトウェア (未完) を載せておきます。

```asm
; カートリッジのROMの先頭0x100 byte分は割り込みベクタなので飛ばす。
; エントリポイントは4byte。たいていはnopしてjpするものらしい。
SECTION "entrypoint", ROM0[$0100]
    nop
        jpmain

; 実際のコードは0x014fから。
; 0x0104 ~ 0x014e はヘッダが入るので使えない。
SECTION "main", ROM0[$014F]
main:
    ; 液晶の垂直同期を待って画面をオン($ff40の7bit目を1)にする。
    ; 垂直同期を待たずにオンオフとか画像書き込みとかすると実機を炒めるらしい(こわ)
            callwait_vblank

        lda, $80
        lda, [$FF40]

        lda, %11100000
                        ld[$FF47], a; BGP

        lda, 0
        ld[$FF43], a
        ld[$FF42], a

            ;callshutdown_lcd

        lda, $80
        lda, [$FF40]

    halt

wait_vblank:
        lda, [$FF44]
        cp145
        jrnz, wait_vblank
        retnc

;shutdown_lcd:
        ;lda, [$FF40]
    ;rlca
            ;retnc
```

本日はこれでおわりです。
