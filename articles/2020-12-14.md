# 初めての音プログラミング - あるいはSound Experimens Pukunui

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の14日目の記事です。

## あらまし

初めて音プログラミングに挑戦したときのことを書きます。

## 音プログラミングをやろうと思った動機

ふだん[Bitwig Studio](https://www.bitwig.com)を使って遊んでいます。DTMについてはいろいろ憧れがあって、昔は[Cherry](https://www.vector.co.jp/soft/win95/art/se071842.html)というソフトで遊んでいたり、[VST](https://ja.wikipedia.org/wiki/Virtual_Studio_Technology)というシンセサイザーやエフェクトのソフトウェアプラグイン規格が流行りだしたころは使ったり作ってみたかったりしたし、Ubuntuをメインプラットフォームとして使うようになってからはGNU/Linuxで動くDAW (Digital Audio Workstaion; 要するにソフトウェアで完結する作曲ソフト) 探しに精を出したりしていました。VST規格に従ったシンセサイザープラグインとして日本製で「フリーソフト」 (FLOSSではないほう) として公開されていた[Synth1](https://daichilab.sakura.ne.jp/softsynth/)に憧れたりする日々でした。

そんな背景があって音のプログラミングをすることにずっと興味があったのですが、ついにつくるかと重い腰を上げて本を購入しました。それから半年。読み終わったのでつくってみるかと始めたのがこちらのリポジトリです。

https://github.com/t-sin/pukunui

ニホンリスとバクが大好きなことはバレていそうですが、キーウィも好きです。なので天王寺動物園のキーウィのプクヌイさんの名前を拝借しました。動物の個体名から採るのはここから始まったのであります。[Common LispのO/RマッパーのMito](https://github.com/fukamachi/mito)は[作者の深町さんのブログ](https://blog.8arrow.org/entry/2016/12/24/140705)にて「ElephantというCommon Lispのオブジェクトストア由来」「愛着も湧く」と語られていましたが、たしかに愛着が湧きますね。

## プクヌイの時間発展

実装言語にはぼくにとって手軽で気持ちよく書けて性能も申し分ない言語であるCommon Lispを採用しました。処理系はClozure CLです。好きなので。音声信号の入出力 (OSやサウンドデバイスとのやりとり) には[PortAudio](http://www.portaudio.com)のCommon Lispバインディングを利用しています。ぼくは妄想が膨らむタイプの人間ですので、クロスプラットフォームにつくって動かしたかったのだと思われます。

これが最初のコミットです。

https://github.com/t-sin/pukunui/commit/46bfce1a53999ab6e139eb2043791d6a1fce71ce

このころちょうどDoug Hoyteの『LET OVER LAMBDA』を読み終えて感銘を受けたころでしたので、信号処理を行うブロックがLet Over Lambdaパターンでつくられています。Pukunuiの実験のときの背後にはBitwig Studioのモジュラーなデバイスのルーティングシステム、それとオーディオ用のビジュアルプログラミング言語の[Pure Data](https://ja.wikipedia.org/wiki/Pure_Data)のモデルやユニットジェネレータの概念などが頭にあり、信号処理ブロック同士をインタラクティブに繋ぎ替えたりできること、を目標に据えて開発していました。オシレータを増やしミックスできるブロックを増やし、ディレイを実装してすごく基本的なことがだんだんできるようになっていくのは達成感がありますね。ローパスフィルタを実装したあたりで、素の、つまりマクロでラップしない関数オブジェクトを書くのがとてもつらくなったのか、ユニット (Pukunuiでの信号処理ブロック) を定義するマクロを生やしたりしています。

https://github.com/t-sin/pukunui/commit/bced68850bb984a8ce67d63ca492c451155977e4

そういえばPukunuiの`defunit`ってこのあとも一度書き直した記憶があるけどLet Over Lambdaスタイルなのは変わってないような…。マジか…。

…と書いていて思い出しました。Pukunuiのユニットは、処理はラムダ式のbody部に展開され、状態の保持には構造体を用いています。書き直しをやった理由のひとつに「状態オブジェクトの継承をしたい」があったのです。どういうことかというと、オシレータ (基本的な波形を生成するユニット) はその波形がサイン波であろうが三角波であろうが、三角関数のθに対応する状態を持つことになります。そこに加えて各種オシレータ固有の状態を持ちます。こういうことってフィルタなどでも発生しそうだな、と実感したので継承がほしかったのです。これを実現するのにCommon Lispの構造体の継承を利用しました。[@carrotflakesさん](https://github.com/carrotflakes)に教えてもらったので使いたくなったからです。あとから多重継承ができないことで苦労することにはなるのですが。

その後はシーケンサーの実装をしていました。シーケンサとは、時間方向に並ぶ情報を記憶しておき、それにしたがって他のユニットに入力する制御用信号を出力するものです。制御用信号には例えばピッチ (音高) の信号やゲート (音量) の信号などがあり、これらをシーケンサで制御することでメロディなどを実現する「信号の列 (シーケンス)」を送り込むというわけです。つくったことがなかったのですさまじく手探りでしたが、lispmeetup #75での発表[『Sounds Like Common Lisp - ゼロからはじめるサウンドプログラミング』](https://www.slideshare.net/t-sin/sounds-like-common-lisp)のころには簡単なメロディは鳴らせるようになりました。

あとは以下のことをするだけだね、とREADMEに書いてありました。

- 譜面的な位置情報の実現
- 基本ユニットを組み合わせて大きく複雑なユニットを構成
- トラックの実現
- インタラクティブなユニット構成の変更
- GUI……！？！？！

そして今 (のmaster) に至ります。

## KLOS: Kiwi Lightweight Object System

唐突に何を、と感じると思うでしょうがPukunuiの話ですご安心ください。

Common Lispの構造体の継承は、もちろん簡易的なものであり複雑な継承はできません。そして、ユースケースであるところのPukunuiのほうが多重継承があったほうがよさそうということがわかります。こうなると「ついにCLOSを使うといがやってきたか」という気持ちになりかけますが、しかし動的ではなくてよいです。ユニットの定義時に指定した継承関係のとおりに静的にディスパッチできればよく、CLOSのような動的なクラス変更などの柔軟性によって実行速度の低下は、信号処理プログラムであるPukunuiには大仰すぎるものです。そこで構造体を用いて軽くて静的なオブジェクトシステムがほしいと強く感じたわけです (イメージ指向であるCommon Lispで静的とはなんぞやという気持ちはあるにせよ)。それをやろうとしたブランチがこちらです。

https://github.com/t-sin/pukunui/tree/klos/klos

Kiwi Lightweight Object System、略してKLOS (きーろす)！！！

本気で言っています。

ちなみに上に書いたKLOSのモチベーションは、いままさに書くことによってすさまじく整理されているため、klosブランチを書いていたときの気持ちと同じではありません。その証左として、[klosブランチのREADME](https://github.com/t-sin/pukunui/blob/klos/klos/README.md)には若干動的そうなAPIが名を連ねています。そして頓挫するわけです。なぜ頓挫したのかは忘れましたが、頓挫はあるあるです。たしか[Kotoのこと](2020-12-01.md)を思いついたのがこのころなので、そちらをはやく実装したかったのかもしれません。

## おわりに

Pukunuiの目標はBitwig Studioでした。そして、ぼくがこれから先につくっていく音系プログラム (Common Lispで実装) のミドルウェアをも目指していました。そしてそれはまだ変わっていません。実際、汎用シーケンサライブラリ等への分離も視野に入れ、またKotoによる成果を戻すことも考えて一度止めている状態です。いつ戻ってくるかはわからないのですが、ちゃんと機能をつくって使っていきたいです。

---

## (当時の) 参考文献

- [青木直史『サウンドプログラミング入門――音響合成の基本とC言語による実装』](https://www.amazon.co.jp/dp/4774155225)
- [小坂直敏『サウンドエフェクトのプログラミング―Cによる音の加工と音源合成』](https://www.amazon.co.jp/dp/4274068943)

## (いまなら読む) 参考文献

- [Curtis Roads『コンピュータ音楽: 歴史・テクノロジー・アート』](https://www.amazon.co.jp/dp/4501532106)
    - この本を手にいれたとき「これで音プログラミング勝つる！」と思った記憶がありますが、原題のとおりチュートリアルですね…奥が深い
- [Atsushi Eno『DAW・シーケンサーエンジンを支える技術』](https://xamaritans.booth.pm/items/2397203)
- [Atsushi Eno『LV2オーディオプラグイン開発者ガイド』](https://xamaritans.booth.pm/items/2480140)
- [岩宮眞一郎『音と音楽の科学』](https://www.amazon.co.jp/dp/4297111918)
