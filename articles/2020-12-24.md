# リスをLispで実装したい

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の24日目の記事です。

## あらまし

リスを実装したいがために、Lispを実装しています。未完。

## 背景

円城塔という作家さんの小説で『リスを実装する』という短編があります ([Kindle](https://www.amazon.co.jp/dp/B00WGS4L18/)と[収めてる文庫](https://www.amazon.co.jp/dp/4309416357/))。円城塔作品がとても好きなのですがその中でもかなり好きなほうに入る作品で、「な、なにを言っているんだ……これは…・？」となってしまいうことも多い円城さんの作品の中ではかなりわかりやすい話でもあります。プログラムが出力する文字列で表現されたリス「マーク」のことを通して、テクノロジーの進化や、ハードウェアとソフトウェアの交わるところに思いを馳せる、すてきな小説です。

「プログラムが出力する文字列で表現されたリス」というところからわかるとおり本文中で、マークがどういう挙動をするプログラムなのかが記述されています。常時起動させておくプログラムで、定時のイベントを持ち (冒頭ではJSTの9時に「マークが起き上がる」という文字列を出力すると記載されている)、内部状態を持ち (木に移動する、寝床に移動する、などの状態遷移がでてくる)、外部からのインタラクションが可能 (キー入力でクルミをあげるとかできる)、といった感じの機能を持っています。

『リスを実装する』を読みながら、プログラムはきっとこうなってるんだろうな、などと考えながら読むわけですが、このリス、なんだか実装できそうじゃないですか。そして、実装すると楽しそうじゃないですか。

そしてさらに、*リスがリスプで*実装されていると、より楽しいと思うのです。

なんてったってLisperですから。

---

(あと[円城さんもLispに興味があるっぽい](https://twitter.com/search?q=from%3Asin_clav%20%E3%83%AA%E3%82%B9%E3%82%92%E5%AE%9F%E8%A3%85&src=typed_query&f=live)のでちょっと笑ってもらえるんじゃないかなと思って)

## Sciurus

そうしてつくっているのが、マークを実装するためのSciurusという名前のLispというわけです。[最低でも3年以上前からつくりたいつくりたい言ってました](https://twitter.com/search?q=from%3Asin_clav%20%E3%83%AA%E3%82%B9%E3%82%92%E5%AE%9F%E8%A3%85&src=typed_query&f=live)。

https://github.com/t-sin/mark

実装言語の選択には変遷があり、Goで書こうとしたりNimで書こうとしたりRustでやろうとしたりした挙句最終的にはC言語 (C11) を選択しました。高級な言語の機能やライブラリに頼らず言語つくってるっぽいことをしよう、という判断によるものです。

Sciurus自体がまだ実装途中です。SciurusはCommon Lispを低機能にした感じの処理系を目指していて、そこにマークを実現するための機能を足していくことを考えています。以下の機能があればリスの実装イケるんじゃないかな、と考えています:

- 基本的な制御構文
- 文字列に関するデータ型と関数
- 時刻に関するデータ型と関数
- 並行処理 (インタラクションに必要かもしれない)

一方で現在、Sciurusはほんとうに基本的なCommon Lispっぽい機能を備えているのみです。

- パッケージとシンボル関連の操作
- レキシカル環境やグローバル環境
- 関数オブジェクト
- 簡易リーダ
- 多値
- マクロシステム (簡易版)
- ファイルI/O

GCはまだありません。ほいほいmallocしてそのままです。マークは放置系プログラムになると思われるのでどこかでGC実装しなければならない。

じつは今年の6月にあった[関西Lispユーザ会#18でもSciurusのことをちょっとだけ話しました](https://www.slideshare.net/t-sin/common-lisp-236311483)が、ちょっぴり進展しているのと『リスを実装する』まわりのことはほとんど話さなかったのでこの記事を書いた、という感じです。

## 進展

関西Lispユーザ会での発表では、制御オペレータがまだcondくらいしかないことを挙げました。`dotimes`や`do`マクロを定義するための布石として、制御オペレータを構成するプリミティブとなるオペレータたちの実装に取り掛かりはじめました。

具体的には`block`/`return`オペレータが増えました。`setjmp()`や`longjmp()`についてちょっと理解が進んだことによる進展です。また`unwind-protect`も増えました。`unwind-protect`は`catch`/`throw`や`tagbody`/`go`でも利用するので、今後改修されていく予定です。

## 今後

`defun`マクロが動いたところで燃え尽きてしまったり、`tagbody`/`go`をインタプリタでやるとあまりうれしみがないというような悩みポイントがあり、ちょくちょく止まってたりしますがいつか完成させてマークを実装して遊びたいものです。

---

インタプリタの改修が若干つらかったり`tagbody`/`go`のうれしみ問題から、仮想機械への道を模索したりしていましたが、それはまた次の機会に……。

## 余談

ぼくが[リス (特にニホンリス) が好きなのは周知の事実](https://photos.google.com/share/AF1QipOxptB09ef9xLzvuDkI1zpUX4F2nIyg-sxPjCwBOtwzs0j2Jqy03F0Z-0esQZ-UEA?key=bGJadWM0R2FMaU9lXzBUcFZlWW84Z3ZwZGZjWENR)だと思いますが、リスを意識した最初のきっかけがこの『リスを実装する』だったことは周知ではないと思います。また、はじめて実装したLispが[nutslisp](https://github.com/t-sin/nutslisp) ([11日目の記事に登場済み](2020-12-11.md))なのはもちろん『リスを実装する』ことが念頭にあったからです。

こうして振り返ってみると、人生における円城さんの影響がでかすぎる。
